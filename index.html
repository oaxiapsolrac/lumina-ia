<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lumina • Chat</title>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* --- CSS ORIGINAL DO DESIGN --- */
    :root {
      --bg: #ffffff;
      --text: #060606;
      --border: #E6E6E6; /* cor das cordas */
      --primary-a: #461244;
      --primary-b: #ba49b0;
      --surface: #f7f7f7;
      --radius: 16px; 
      --max-w: 860px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; background: var(--bg); }
    body {
      margin: 0;
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }
    header {
      position: sticky;
      top: 0;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      z-index: 1;
    }
    .header-inner {
      max-width: var(--max-w);
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
    }
    .logo, .logo-img { width: 45px; height: 45px; }
    .brand { font-weight: 900; letter-spacing: 6px; }
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 290px; /* largura do campo de historico de conversa */
      background: var(--bg);
      border-right: 1px solid var(--border);
      padding-top: 80px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 10px 110px;
      border-bottom: 1px solid var(--border);
      font-weight: 690;
    }
    .new-chat {
      margin: 12px 16px; /* margem externa */
      border: 1px solid var(--border); /* cor da borda */
      border-radius: 8px; /* arredondamento da borda */
      padding: 10px 12px; /* espaçamento interno */
      background: #FFF; /* cor de fundo */
      cursor: pointer; /* cursor de ponteiro ao passar sobre */
    }
    .history {
      list-style: none;
      padding: 0; /* remove o espaçamento interno */
      margin: 6px 8px; /* margem externa */
      overflow-y: auto; /* adiciona barra de rolagem vertical quando necessário */
      flex: 1; /* ocupa o espaço restante na coluna */
    }
    .history-item {
      border-radius: 8px;
      padding: 10px 10px; /* espaçamento interno */
      margin: 4px 8px; /* margem externa */
      border: 1px solid var(--border); /* cor da borda */
      background: #FFF;
      cursor: pointer;
      color: var(--text);
      font-size: 14px; /* tamanho da fonte */
      display: flex;
      align-items: center;
      gap: 10px; /* espaçamento entre os itens */
      justify-content: space-between;
    }
    .history-item .title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .delete-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px; /* tamanho da fonte */
      padding: 4px 8px; /* espaçamento interno */
      border-radius: 6px; /* arredondamento da borda */
      cursor: pointer; /* cursor de ponteiro ao passar sobre */
    }
    .delete-btn:hover { background: #F5F5F5; color: #D32F2F; }
    main { flex: 1; }
    .content {
      max-width: var(--max-w);
      margin: 0 auto; /* centraliza o conteúdo horizontalmente */
      padding: 32px 20px 108px; /* espaçamento interno */
      display: flex;
      flex-direction: column;
      gap: 18px; /* espaçamento entre os itens */
      margin-left: 280px; /* margem externa à esquerda */
    }
    .message {
      display: flex;
      gap: 12px; /* espaçamento entre os itens */
      justify-content: flex-start;
      width: 100%; /* ocupa toda a largura disponível */
    }
    .message .bubble { max-width: 75%; }
    .message.from-user { flex-direction: row-reverse; justify-content: flex-end; }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-a), var(--primary-b));
      flex-shrink: 0;
    }
    .bubble {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      line-height: 1.6;
    }
    .from-user .avatar { background: #D1D5DB; }
    .from-user .bubble { background: #FFFFFF; text-align: right; margin-left: auto; }
    
    /* --- CSS NOVO: FORMATAÇÃO DA RESPOSTA (MARKDOWN) --- */
    .bubble p { margin: 0 0 10px 0; } /* espaçamento entre os parágrafos */
    .bubble p:last-child { margin: 0; } /* remove o espaçamento inferior do último parágrafo */
    /* Listas organizadas */
    .bubble ul, .bubble ol { margin: 5px 0 5px 20px; padding: 0; }
    .bubble li { margin-bottom: 5px; }
    /* Negrito com a cor da marca */
    .bubble strong, .bubble b { font-weight: 700; color: var(--primary-a); }
    
    /* --- RESTO DO DESIGN --- */
    
    /* --- BARRA DE DIGITAÇÃO ESTILO GEMINI --- */
    
    /* O container invisível que posiciona a barra */
    .composer {
      position: fixed;
      bottom: 24px; /* Flutua um pouco acima do fundo */
      left: 50%; /* Centraliza na tela */
      transform: translateX(-50%); /* Ajuste exato do centro */
      width: 100%;
      max-width: 750px; /* Largura máxima parecida com o Gemini */
      padding: 0 20px;
      background: transparent;
      border: none;
      z-index: 100; /* Garante que fique acima de tudo */
    }

    /* A barra escura arredondada em si */
    .composer-inner {
      background: #1E1F20; /* Cor escura do Gemini */
      border-radius: 36px; /* Bordas bem redondas */
      padding: 8px 12px 8px 24px; /* Espaçamento interno */
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Sombra suave */
      border: 1px solid #333; /* Borda sutil */
    }

    /* O campo onde escreve */
    .input {
      flex: 1;
      background: transparent;
      border: none;
      color: #E3E3E3; /* Texto claro */
      font-size: 16px;
      outline: none;
      padding: 10px 0;
    }

    /* Cor do texto de "Digite aqui..." */
    .input::placeholder {
      color: #8E918F; 
    }

    /* Botão de Enviar */
    button#send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--primary-a); /* Mantém sua cor roxa da marca */
      /* Se quiser igual ao Gemini (seta branca), use: background: #FFF; color: #000; */
      color: white;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    button#send:hover {
      filter: brightness(1.2);
    }
    
    button#send:disabled {
      background: #a13d9c;
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Ajuste para telas pequenas (Celular) */
    @media (max-width: 768px) {
      .composer {
        left: 0;
        transform: none;
        max-width: 100%;
        bottom: 10px;
      }
    }
    .typing { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #BDBDBD; animation: dots 1s ease-in-out infinite; }
    .dot:nth-child(2) { animation-delay: 0.15s; }
    .dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes dots { 0% { opacity: 0.2; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-2px); } 100% { opacity: 0.2; transform: translateY(0); } }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <img class="logo-img" src="logo.png" alt="LUMINA" onerror="this.src='logo.png'"/>
      <div class="brand">LUMINA</div>
    </div>
  </header>
  <main>
    <aside class="sidebar">
      <div class="sidebar-header">Histórico</div>
      <button id="newChat" class="new-chat">Novo chat</button>
      <ul id="history" class="history"></ul>
    </aside>
    <div class="content">
      </div>
  </main>
  <div class="composer">
    <div class="composer-inner">
      <input id="prompt" class="input" type="text" placeholder="Pergunte sobre mulheres na tech..." autocomplete="off"/>
      <button id="send" class="send" disabled>Enviar</button>
    </div>
  </div>

<script>
    const input = document.getElementById('prompt');
    const send = document.getElementById('send');
    const historyEl = document.getElementById('history');
    const newChatBtn = document.getElementById('newChat');
    let currentConversationId = null;

    // --- 1. GERENCIAMENTO DE HISTÓRICO ---
    function loadHistory() {
      const raw = localStorage.getItem('wd-history');
      const list = raw ? JSON.parse(raw) : [];
      historyEl.innerHTML = '';
      list.forEach(item => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.dataset.id = item.id;
        
        const title = document.createElement('span');
        title.className = 'title';
        title.textContent = item.title || 'Sem título';
        
        // Botão de excluir
        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.setAttribute('aria-label', 'Excluir conversa');
        del.textContent = '×';
        
        li.appendChild(title);
        li.appendChild(del);
        
        // Eventos de clique
        li.addEventListener('click', () => loadConversation(item.id));
        del.addEventListener('click', (e) => { e.stopPropagation(); deleteConversation(item.id); });
        
        historyEl.appendChild(li);
      });
    }

    function saveHistory(history) {
      localStorage.setItem('wd-history', JSON.stringify(history));
    }

    function getHistory() {
      const raw = localStorage.getItem('wd-history');
      return raw ? JSON.parse(raw) : [];
    }

    function deleteConversation(id) {
      let history = getHistory();
      history = history.filter(h => h.id !== id); // Remove a conversa
      saveHistory(history);
      
      // Se estava vendo a conversa apagada, limpa a tela
      if (currentConversationId === id) {
        currentConversationId = null;
        renderAssistantGreeting();
      }
      loadHistory(); // Atualiza a lista lateral
    }

    // --- 2. INTERFACE E MENSAGENS ---
    function renderAssistantGreeting() {
      const content = document.querySelector('.content');
      content.innerHTML = '';
      
      const msg = document.createElement('div');
      msg.className = 'message';
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = 'Olá! Sou a LUMINA. Pergunte-me sobre mulheres na tecnologia!';
      
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      content.appendChild(msg);
      
      
    }

    function loadConversation(id) {
      const history = getHistory();
      const conv = history.find(h => h.id === id);
      if (!conv) return;
      currentConversationId = id;
      const content = document.querySelector('.content');
      content.innerHTML = '';
      
      conv.messages.forEach(m => {
        const msg = document.createElement('div');
        msg.className = 'message' + (m.role === 'user' ? ' from-user' : '');
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        // FORMATAÇÃO DO HISTÓRICO
        if (m.role === 'user') {
          bubble.textContent = m.text;
        } else {
          bubble.innerHTML = marked.parse(m.text);
        }

        msg.appendChild(avatar);
        msg.appendChild(bubble);
        content.appendChild(msg);
      });
      window.scrollTo(0, document.body.scrollHeight);
    }

    function startNewConversation() {
      currentConversationId = null;
      renderAssistantGreeting();
    }

    function appendMessage(role, text) {
      const content = document.querySelector('.content');
      const msg = document.createElement('div');
      msg.className = 'message' + (role === 'user' ? ' from-user' : '');
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      // FORMATAÇÃO DE MENSAGENS NOVAS
      if (role === 'user') {
        bubble.textContent = text;
      } else {
        bubble.innerHTML = marked.parse(text); // Transforma Markdown em HTML
      }

      msg.appendChild(avatar);
      msg.appendChild(bubble);
      content.appendChild(msg);
      window.scrollTo(0, document.body.scrollHeight);
    }

    function appendTyping() {
      const content = document.querySelector('.content');
      const msg = document.createElement('div');
      msg.className = 'message';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      const bubble = document.createElement('div');
      bubble.className = 'bubble typing';
      
      const d1 = document.createElement('span'); d1.className = 'dot';
      const d2 = document.createElement('span'); d2.className = 'dot';
      const d3 = document.createElement('span'); d3.className = 'dot';
      
      bubble.appendChild(d1); bubble.appendChild(d2); bubble.appendChild(d3);
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      content.appendChild(msg);
      window.scrollTo(0, document.body.scrollHeight);
      return msg;
    }

    // --- 3. CONEXÃO COM O BACKEND (RENDER) ---
    input.addEventListener('input', () => { send.disabled = !input.value.trim(); });
    input.addEventListener('keydown', e => { if (e.key === 'Enter' && !send.disabled) { e.preventDefault(); send.click(); } });
    newChatBtn.addEventListener('click', startNewConversation);

    send.addEventListener('click', async () => {
      const text = input.value.trim();
      if (!text) return;

      appendMessage('user', text);
      
      // Salva ou cria conversa no histórico
      let history = getHistory();
      if (!currentConversationId) {
        currentConversationId = Date.now().toString();
        history.unshift({ id: currentConversationId, title: text.slice(0, 40), messages: [] });
      }
      const idx = history.findIndex(h => h.id === currentConversationId);
      if (idx !== -1) {
        history[idx].messages.push({ role: 'user', text });
        saveHistory(history);
        loadHistory(); // Atualiza sidebar
      }

      input.value = '';
      send.disabled = true;

      const typingEl = appendTyping();

      try {
        // CONEXÃO OFICIAL COM SEU SERVIDOR NA NUVEM
        const response = await fetch('http://localhost:3000/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mensagem: text })
        });

        const data = await response.json();
        
        typingEl.remove(); // Remove animação
        
        const reply = data.resposta;

        appendMessage('assistant', reply);

        // Salva resposta da IA no histórico
        let h = getHistory();
        const i = h.findIndex(v => v.id === currentConversationId);
        if (i !== -1) {
          h[i].messages.push({ role: 'assistant', text: reply });
          saveHistory(h);
        }

      } catch (error) {
        typingEl.remove();
        console.error(error);
        appendMessage('assistant', "⚠️ Erro: Não foi possível conectar ao servidor.");
      }
    });

    // Inicia o app
    loadHistory();
    renderAssistantGreeting();
</script>
</body>
</html>