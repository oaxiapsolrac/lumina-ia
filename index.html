<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lumina • Chat</title>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --bg: #FFFFFF; --text: #1F1F1F; --primary-a: #6A1B9A; --primary-b: #FF4081; --surface: #FAFAFA; --radius: 16px; --max-w: 860px; --border: #E6E6E6; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); font-family: sans-serif; display: flex; flex-direction: column; }
    
    /* Layout */
    .content { max-width: var(--max-w); margin: 0 auto; padding: 32px 20px 108px; margin-left: 280px; flex: 1; display: flex; flex-direction: column; gap: 18px; }
    .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; border-right: 1px solid var(--border); padding: 20px; background: #fff; z-index: 100;}
    .composer { position: fixed; left: 280px; right: 0; bottom: 0; background: #fff; border-top: 1px solid var(--border); padding: 20px; }
    .composer-inner { max-width: var(--max-w); margin: 0 auto; display: flex; gap: 10px; }
    
    /* Balões de mensagem */
    .message { display: flex; gap: 12px; width: 100%; }
    .message.from-user { flex-direction: row-reverse; }
    .avatar { width: 30px; height: 30px; border-radius: 50%; background: #ccc; flex-shrink: 0; }
    .message.from-user .avatar { background: #666; }
    .message:not(.from-user) .avatar { background: linear-gradient(135deg, var(--primary-a), var(--primary-b)); }
    
    .bubble { background: var(--surface); border: 1px solid var(--border); padding: 14px 18px; border-radius: 16px; line-height: 1.6; max-width: 80%; }
    .message.from-user .bubble { background: #fff; text-align: right; }

    /* 2. IMPORTANTE: ESTILO DO NEGRITO E LISTAS */
    .bubble strong { font-weight: 900; color: var(--primary-a); }
    .bubble ul, .bubble ol { margin: 10px 0 10px 20px; padding: 0; }
    .bubble li { margin-bottom: 5px; }
    .bubble p { margin: 0 0 10px 0; }
    .bubble p:last-child { margin: 0; }

    /* Inputs e Botões */
    input { flex: 1; padding: 12px 20px; border-radius: 30px; border: 1px solid var(--border); outline: none; font-size: 16px; }
    button#send { padding: 10px 20px; border-radius: 30px; border: none; background: var(--primary-a); color: white; font-weight: bold; cursor: pointer; }
    button#send:disabled { opacity: 0.5; }
    
    /* Histórico */
    .history-list { list-style: none; padding: 0; margin-top: 20px; }
    .history-item { padding: 10px; margin-bottom: 5px; background: #f5f5f5; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
    .delete-btn { background: none; border: none; color: red; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h3>Histórico</h3>
    <button onclick="startNewChat()" style="width:100%; padding:10px; cursor:pointer;">+ Novo Chat</button>
    <ul id="history" class="history-list"></ul>
  </aside>

  <main class="content" id="chat-content">
    </main>

  <div class="composer">
    <div class="composer-inner">
      <input type="text" id="prompt" placeholder="Digite sua pergunta..." autocomplete="off">
      <button id="send">Enviar</button>
    </div>
  </div>

  <script>
    const chatContent = document.getElementById('chat-content');
    const input = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');
    const historyList = document.getElementById('history');
    let currentId = null;

    // --- FUNÇÕES DE EXIBIÇÃO ---
    
    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'message ' + (role === 'user' ? 'from-user' : 'from-ai');
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      // 3. IMPORTANTE: AQUI APLICAMOS A FORMATAÇÃO
      if (role === 'user') {
        bubble.textContent = text;
      } else {
        // Se for IA, converte Markdown (*negrito*) para HTML (<b>negrito</b>)
        bubble.innerHTML = marked.parse(text);
      }

      div.appendChild(avatar);
      div.appendChild(bubble);
      chatContent.appendChild(div);
      window.scrollTo(0, document.body.scrollHeight);
    }

    function showTyping() {
      const div = document.createElement('div');
      div.id = 'typing-indicator';
      div.className = 'message';
      div.innerHTML = '<div class="avatar"></div><div class="bubble">...</div>';
      chatContent.appendChild(div);
      window.scrollTo(0, document.body.scrollHeight);
    }

    function removeTyping() {
      const el = document.getElementById('typing-indicator');
      if (el) el.remove();
    }

    // --- HISTÓRICO ---
    function getHistory() { return JSON.parse(localStorage.getItem('lumina-chats') || '[]'); }
    function saveHistory(data) { localStorage.setItem('lumina-chats', JSON.stringify(data)); }

    function updateHistoryUI() {
      const chats = getHistory();
      historyList.innerHTML = '';
      chats.forEach(chat => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `<span>${chat.title}</span>`;
        
        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.innerText = '×';
        del.onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); };
        
        li.onclick = () => loadChat(chat.id);
        li.appendChild(del);
        historyList.appendChild(li);
      });
    }

    function deleteChat(id) {
      const chats = getHistory().filter(c => c.id !== id);
      saveHistory(chats);
      if (currentId === id) startNewChat();
      updateHistoryUI();
    }

    function loadChat(id) {
      currentId = id;
      chatContent.innerHTML = '';
      const chat = getHistory().find(c => c.id === id);
      if (chat) {
        chat.messages.forEach(m => appendMessage(m.role, m.text));
      }
    }

    function startNewChat() {
      currentId = null;
      chatContent.innerHTML = '';
      appendMessage('ai', 'Olá! Sou a Lumina v2. Pergunte sobre mulheres na tecnologia!');
    }

    // --- ENVIO ---
    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;

      // 1. Mostra pergunta
      appendMessage('user', text);
      input.value = '';
      
      // 2. Salva no histórico
      let chats = getHistory();
      if (!currentId) {
        currentId = Date.now().toString();
        chats.unshift({ id: currentId, title: text.slice(0, 20), messages: [] });
      }
      const chatIndex = chats.findIndex(c => c.id === currentId);
      if (chatIndex !== -1) {
        chats[chatIndex].messages.push({ role: 'user', text });
        saveHistory(chats);
        updateHistoryUI();
      }

      // 3. Envia para a API
      showTyping();
      try {
        const req = await fetch('https://lumina-backend-zsak.onrender.com/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mensagem: text })
        });
        const res = await req.json();
        
        removeTyping();
        const reply = res.resposta;

        // 4. Mostra resposta
        appendMessage('ai', reply);

        // 5. Salva resposta
        chats = getHistory();
        const idx = chats.findIndex(c => c.id === currentId);
        if (idx !== -1) {
          chats[idx].messages.push({ role: 'ai', text: reply });
          saveHistory(chats);
        }

      } catch (err) {
        removeTyping();
        appendMessage('ai', 'Erro de conexão.');
      }
    };

    // Enter para enviar
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // Iniciar
    updateHistoryUI();
    startNewChat();
  </script>
</body>
</html>